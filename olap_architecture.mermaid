flowchart TD
    User(["ðŸ‘¤ Business User\n(Browser)"])

    subgraph Streamlit["ðŸŒ Streamlit Web Application (app.py)"]
        Input["ðŸ’¬ Chat Input\nst.chat_input()"]
        Sidebar["ðŸ”§ Sidebar Filters\nYear / Region / Category"]
        Display["ðŸ“Š Results Display\nChart + Table + Insight + Follow-ups"]
    end

    subgraph DataLayer["ðŸ—„ï¸ Data Layer (data_utils.py)"]
        Cache["âš¡ Cached DataFrame\nst.cache_data"]
        CSV["ðŸ“„ global_retail_sales.csv\n10,000 rows Â· 2022â€“2024"]
        Exec["ðŸ”’ Safe exec()\npandas code sandbox"]
    end

    subgraph PromptLayer["ðŸ“ Prompt Layer (prompts.py)"]
        SysPrompt["ðŸ“‹ System Prompt\nSchema + OLAP Definitions\n+ JSON Contract"]
        History["ðŸ•“ Chat History\nMulti-turn context"]
    end

    subgraph LLM["ðŸ¤– Groq API (LLaMA 3.3 70B)"]
        Groq["âš¡ Groq Inference\nFree tier Â· Global access"]
    end

    subgraph JSONResponse["ðŸ“¦ JSON Response"]
        Op["operation\nslice Â· dice Â· drill_down\ngroup_summarize Â· compare"]
        Code["pandas_code\ndf_result = df.groupby..."]
        Chart["chart_type + config\nbar Â· line Â· pie Â· table"]
        Insight["insight\nBusiness narrative"]
        Followups["follow_ups\n3 suggested questions"]
    end

    subgraph OLAPOps["ðŸ”· OLAP Operations"]
        Slice["ðŸ”ª Slice\nSingle filter"]
        Dice["ðŸŽ² Dice\nMulti filter"]
        GroupSum["ðŸ“Š Group & Summarize\ngroupby + agg"]
        DrillDown["ðŸ” Drill-Down\nYear â†’ Quarter â†’ Month"]
        RollUp["â¬†ï¸ Roll-Up\nDetail â†’ Summary"]
        Compare["âš–ï¸ Compare\n2023 vs 2024"]
    end

    subgraph Viz["ðŸ“ˆ Visualization (Plotly)"]
        Bar["Bar Chart"]
        Line["Line Chart"]
        Pie["Pie Chart"]
        Table["Data Table"]
    end

    User -->|"asks question"| Input
    Sidebar -->|"pre-filters df"| Cache
    CSV -->|"loaded once"| Cache
    Input --> History
    History --> SysPrompt
    SysPrompt -->|"full context"| Groq
    Groq --> JSONResponse
    Op --> OLAPOps
    Code -->|"executed against\nfiltered df"| Exec
    Cache --> Exec
    Exec -->|"df_result"| Viz
    Chart --> Viz
    Insight --> Display
    Followups --> Display
    Viz --> Display
    Display -->|"shows results"| User
    Followups -->|"click to re-query"| Input

    style Streamlit fill:#EFF6FF,stroke:#2E75B6,stroke-width:2px
    style DataLayer fill:#F0FDF4,stroke:#16A34A,stroke-width:2px
    style PromptLayer fill:#FFFBEB,stroke:#D97706,stroke-width:2px
    style LLM fill:#F5F3FF,stroke:#7C3AED,stroke-width:2px
    style JSONResponse fill:#FFF1F2,stroke:#E11D48,stroke-width:2px
    style OLAPOps fill:#F0F9FF,stroke:#0284C7,stroke-width:2px
    style Viz fill:#FDF4FF,stroke:#9333EA,stroke-width:2px
    style User fill:#1F3864,color:#FFFFFF,stroke:#1F3864
